<!DOCTYPE html>

<html lang="en">
<meta charset="utf-8">
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link rel="stylesheet" href="css/main.css" type="text/css">
  <title>Flashpoint</title>
</head>
<body>
  <div class="flashpoint_container">
    <div class="flashpoint_map" id="flashpoint_map">
    </div>
    <div class="flashpoint_information" id="flashpoint_information">
      <div class="clearfix top_bar">
        <div class="box close_button">&times;</div>
        <div class="box code"></div>
        <div class="box type"></div>
      </div>
      <div class="flashpoint_information_text">
          <div class="title"></div>
          <div class="belligerents_text">Belligerents</div>
          <div class="belligerents_list"></div>
          <div class="sitrep">Situation</div>
          <div class="description"></div>
          <div class="sources"></div>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="maps/worldmapdetail.json"></script>
  <script type="text/javascript" src="data/conflicts_data.json"></script>
  <script type="text/javascript">
    const debug = false;

    let conflict_regions = {};
    for (conflict in conflicts){
      for (region in conflicts[conflict].regions){
        conflict_regions[conflicts[conflict].regions[region]] =  conflict;
      };
    };

    function FeaturesConflictMap(region, layer) {
      if (region.properties.id in conflict_regions){

        let conflict = conflicts[conflict_regions[region.properties.id]];

        layer.on("click", function (e) {
          const zoom = conflict.zoom,
                center = conflict.center;
          flashpoint_map.setView(center, zoom);
        });
      };
      if (debug){
        layer.on("click", function (e) {
            console.log(region.properties.id, region.properties.name, [e.latlng['lat'], e.latlng['lng']]);
        });
      };


    };

    function StyleConflictMap(region) {

        if (region.properties.id in conflict_regions){

          return {
                  className: "severity_scale_code_" + conflicts[conflict_regions[region.properties.id]].code,
                  interactive: true
                 }

        } else{
          if (debug){
            return {
                    className: "region_debug",
                    interactive: true
                   }
          } else {
            return {
                    className: "region_hide",
                    interactive: false
                   }
          };

        };
    };

    // Loading the two GeoJSON maps.

    const BaseMap = L.tileLayer("https://api.mapbox.com/styles/v1/paddowonderland/ckw9fqnzy07c715odzos11gmi/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoicGFkZG93b25kZXJsYW5kIiwiYSI6ImNrN3J6NWp3MjBiMzkzb21yeXp2b2FubjEifQ.EY3uhB3fvOcmpHBcFMfajw"),
          ConflictMap = L.geoJson(world_map_detail, {noWrap: true, onEachFeature: FeaturesConflictMap, style: StyleConflictMap});

    // Initiating Leaflet map
    const flashpoint_map = L.map("flashpoint_map", {
      center: [40, 0],
      maxBounds: L.latLngBounds([[-90, -180], [90, 180]]),
      zoom: 3.75,
      minZoom: 3.75,
      maxZoom: 12,
      zoomControl: false,
      doubleClickZoom: true,
      attributionControl: false,
      layers: [
        BaseMap,
        ConflictMap
      ]
    });


    $("#flashpoint_information .close_button").on("click", function (e) {
        $("#flashpoint_information").css({"width": "0"});
    });
    const codes = {
                    "green": "noteworthy",
                    "yellow": "escalating",
                    "orange": "dangerous",
                    "red": "critical"
                  }
    function addConflictMarker(conflict) {

      let conflict_marker = new L.marker(conflict.center, { opacity: 0});
      conflict_marker.bindTooltip(conflict.title, {permanent: true, interactive: true, className: "conflict_label", direction: 'center', offset: [0, 0] });
      conflict_marker.addTo(flashpoint_map);

      conflict_marker.on("click", function (e) {
          $("#flashpoint_information .code").css({"background-color": "var(--severity_scale_code_"+conflict.code+"_fill_color)"})
          $("#flashpoint_information").css({"width": "100%"});
          $("#flashpoint_information .type").html(conflict.type);
          $("#flashpoint_information .code").html(codes[conflict.code]);
          $("#flashpoint_information .title").html(conflict.title);
          $("#flashpoint_information .description").html(conflict.description);
          let belligerent_list = "";
          belligerent_list += "<ol>";
          for (belligerent in conflict.belligerents){
            belligerent_list += "<li>" + conflict.belligerents[belligerent] + "</li>";

          };
          belligerent_list += "<ol>";

          $("#flashpoint_information .belligerents_list").html(belligerent_list);
      });
    };

    for (conflict in conflicts) {
      addConflictMarker(conflicts[conflict]);
    };

  </script>
</body>
</html>
